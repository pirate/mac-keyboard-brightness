#!/usr/bin/env python3
"""Generate a continuous sine wave as an MSIG1 float32 mono stream."""

from __future__ import annotations

import argparse
import math
import sys
from pathlib import Path

REPO_ROOT = Path(__file__).resolve().parent
LIB_ROOT = REPO_ROOT / "lib"
for _p in reversed((LIB_ROOT, REPO_ROOT)):
    if str(_p) not in sys.path:
        sys.path.insert(0, str(_p))

from bootstrap import maybe_reexec_venv

maybe_reexec_venv(__file__)


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description="Generate sine wave float32 mono stream for piping into other bin tools."
    )
    parser.add_argument(
        "frequency_hz",
        type=float,
        help="Sine frequency in Hz.",
    )
    parser.add_argument(
        "--rate",
        type=float,
        default=48000.0,
        help="Output sample rate in Hz (default: 48000).",
    )
    parser.add_argument(
        "--amp",
        type=float,
        default=0.2,
        help="Sine amplitude (default: 0.2).",
    )
    parser.add_argument(
        "--block-size",
        type=int,
        default=1024,
        help="Samples per write (default: 1024).",
    )
    parser.add_argument(
        "--seconds",
        type=float,
        default=None,
        help="Optional finite duration in seconds (default: run until interrupted).",
    )
    parser.add_argument(
        "--raw",
        action="store_true",
        help="Write raw float32 payload without MSIG1 header.",
    )
    return parser.parse_args()


def main() -> int:
    args = parse_args()

    if args.frequency_hz <= 0:
        raise SystemExit("frequency_hz must be > 0")
    if args.rate <= 0:
        raise SystemExit("--rate must be > 0")
    if args.block_size <= 0:
        raise SystemExit("--block-size must be > 0")
    if args.amp < 0:
        raise SystemExit("--amp must be >= 0")
    if args.seconds is not None and args.seconds <= 0:
        raise SystemExit("--seconds must be > 0")

    try:
        import numpy as np
    except Exception as exc:
        raise SystemExit(f"numpy is required: {exc}") from exc

    try:
        from signal_stream import FloatSignalWriter, install_sigpipe_default
    except Exception as exc:
        raise SystemExit(f"sine dependencies unavailable: {exc}") from exc

    install_sigpipe_default()
    writer = FloatSignalWriter.to_stdout(sample_rate=float(args.rate), raw=args.raw)

    rate = float(args.rate)
    amp = float(args.amp)
    block = int(args.block_size)
    dphi = 2.0 * math.pi * float(args.frequency_hz) / rate
    phase = 0.0

    remaining = None
    if args.seconds is not None:
        remaining = int(round(float(args.seconds) * rate))

    try:
        while True:
            n = block if remaining is None else min(block, remaining)
            if n <= 0:
                break
            t = phase + dphi * np.arange(n, dtype=np.float64)
            chunk = (amp * np.sin(t)).astype(np.float32, copy=False)
            writer.write(chunk)
            writer.flush()
            phase = (phase + dphi * n) % (2.0 * math.pi)
            if remaining is not None:
                remaining -= n
    except KeyboardInterrupt:
        return 0
    except BrokenPipeError:
        return 0

    return 0


if __name__ == "__main__":
    raise SystemExit(main())
